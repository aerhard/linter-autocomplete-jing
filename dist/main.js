"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("atom"),e=require("path"),r=require("stream"),a=require("string_decoder"),n=require("net"),o=require("child_process"),s=require("fs");function i(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var c=i(e),u=i(r),l=i(a),p=i(o),m=i(s);const d=/"[^<]*?"|'[^<]*?'|<\/|<|>/g,g=/"[^<]*?"|'[^<]*?'|<|\/>|>/g,f=({editor:t,bufferPosition:e})=>{let r=null;return t.scanInBufferRange(g,[e,t.getBuffer().getEndPosition()],(({matchText:t,range:e,stop:a})=>{t.startsWith("'")||t.startsWith('"')||("<"!==t&&(r=[e.start.row,e.start.column+t.length]),a())})),r},h=(t,e,r)=>{const[a,n]=t.split("#");if("string"==typeof n){const t=`ns\${${++e}}`,o=a.replace(/\*/g,(()=>`\${${++e}}`)),s="*"===n?`\${${++e}}`:n;return{snippet:`${t}:${o}${r?`="\${${++e}}"`:""} xmlns:${t}="${s}"`,displayText:""===n?`${a} [no namespace]`:`${a} (${n})`,tabstopMarkerId:e}}return{snippet:`${a.replace(/\*/g,(()=>`\${${++e}}`))}${r?`="\${${++e}}"`:""}`,displayText:a,tabstopMarkerId:e}},E=[":","A-Z","_","a-z","\\xC0-\\xD6","\\xD8-\\xF6","\\u00F8-\\u02FF","\\u0370-\\u037D","\\u037F-\\u1FFF","\\u200C-\\u200D","\\u2070-\\u218F","\\u2C00-\\u2FEF","\\u3001-\\uD7FF","\\uF900-\\uFDCF","\\uFDF0-\\uFFFD"].join(""),T=[E,"-",".","0-9","\\u00B7","\\u0300-\\u036F","\\u203F-\\u2040"].join(""),v=new RegExp(`[${E}][${T}]*$`),N=new RegExp("^["+T+"]*=(\".*?\"|'.*?')"),b=async(t,e,r,a,n)=>{const{editor:o,bufferPosition:s}=t,i=(t=>{const e=t.match(v);return e?e[0]:""})(n),c=f(t);if(!c)return[];const u=o.getTextInBufferRange([[0,0],[s.row,s.column-i.length]]),l=o.getTextInBufferRange([s,c]),p=l.match(N),m=!p,d=u+(p?l.substr(p[0].length):l);return((t,e,r)=>t.filter((t=>t.value.startsWith(e))).map((t=>{const{value:a,documentation:n}=t,{snippet:o,displayText:s}=h(a,0,r);return{snippet:o,displayText:s,type:"attribute",replacementPrefix:e,description:n?n.join("\n"):void 0,retrigger:r}})))(await a.requestAutocompleteSuggestions(r,e,{type:"N"},d),i,m)},w=new RegExp("[^ \t\r\n]+$"),A=(t,e)=>{const r=t.getTextInBufferRange([[0,0],e]);return Buffer.byteLength(r)},x=new RegExp(`([${E}][${T}]*)="([^"]*)`),I=new RegExp(`([${E}][${T}]*)='([^']*)`),y=t=>{const e=new RegExp(Object.keys(t).join("|"),"g");return r=>r.replace(e,(e=>t[e]))},_=y({"&":"&amp;","<":"&lt;","'":"&apos;"}),P=y({"&":"&amp;","<":"&lt;",'"':"&quot;"}),C=(t,e,r)=>{const a=(t=>{const e=t.match(w);return e?e[0]:""})(e);return t.filter((t=>{const{value:r,listItem:n}=t;return r.startsWith(n?a:e)})).map((t=>{const{value:n,documentation:o,listItem:s}=t;return{snippet:r?P(n):_(n),displayText:n,type:"value",rightLabel:s?"List Item":void 0,replacementPrefix:s?a:e,description:o?o.join("\n"):void 0}}))},S=async(t,e,r,a,n)=>{const{editor:o}=t,s=(({editor:t,bufferPosition:e},r)=>{const a=r?x:I;let n;return t.backwardsScanInBufferRange(a,[e,[0,0]],(({match:t,stop:e})=>{n=t,e()})),n?{name:n[1],valueFragmentPrecedingCursor:n[2]}:null})(t,n);if(!s)return[];const i=f(t);if(!i)return[];const c=o.getText(),u=await a.requestAutocompleteSuggestions(r,e,{type:"V",attName:s.name,tagEndDelimiterBufferIndex:A(o,i)},c);return C(u,s.valueFragmentPrecedingCursor,n)},D=[{value:"!--  --\x3e",snippet:"!-- ${1} --\x3e",description:"Comment"},{value:"![CDATA[]]>",snippet:"![CDATA[${1}]]>",description:"CDATA Section"}],O=(t,e,r)=>t.concat(D).filter((t=>("closing"in t&&t.closing?"/"+t.value:t.value).startsWith(e))).map((t=>"snippet"in t?((t,e)=>{const{value:r,snippet:a,description:n}=t;return{snippet:a,displayText:r,type:"tag",replacementPrefix:e,description:n,retrigger:!1}})(t,e):t.closing?((t,e,r)=>{const{value:a}=t,n=r?`/${a}`:`/${a}>`;return{snippet:n,displayText:n,type:"tag",replacementPrefix:e,description:"Element End Tag",retrigger:!1}})(t,e,r):((t,e,r)=>{const{value:a,empty:n,attributes:o=[],documentation:s}=t,[i,c]=a.split("#");let u=0;const l=i.replace(/\*/g,(()=>`\${${++u}}`));if(r)return{snippet:l,displayText:i,type:"tag",replacementPrefix:e,description:s?s.join("\n"):void 0,retrigger:!1};const p=u>0;let m,d;"string"==typeof c?(d=[`xmlns="${"*"===c?`\${${++u}}`:c}"`],m=""===c?`${i} [no namespace]`:`${i} (${c})`):(d=[],m=i);const g=o.map((t=>{const{snippet:e,tabstopMarkerId:r}=h(t,u,!0);return u=r,e})),f=[l].concat(d).concat(g).join(" "),E=n?f+"/>":`${f}>\${${++u}}</${l}>`,T=u>0&&!p;return{snippet:E,displayText:m,type:"tag",replacementPrefix:e,description:s?s.join("\n"):void 0,retrigger:T}})(t,e,r))),F=async(t,e,r,a,n)=>{const{editor:o,bufferPosition:s}=t,i=o.getTextInBufferRange([[0,0],[s.row,s.column-n.length-1]]),c=await a.requestAutocompleteSuggestions(r,e,{type:"E"},i),u=(t=>!!f(t))(t);return O(c,n,u)},R=new RegExp(`<(!|/|/?[${E}][${T}]*)?$`),L=(t,e,r,a)=>{const n=(({editor:t,bufferPosition:e})=>t.getTextInBufferRange([[e.row,0],e]))(t),o=(t=>{const e=t.match(R);return e?e[1]||"":null})(n);if(null!==o)return F(t,e,r,a,o);const s=t.scopeDescriptor.getScopesArray();if((t=>t.some((t=>t.startsWith("meta.tag.xml")||"meta.tag.no-content.xml"===t)))(s)){const o=(t=>t.find((t=>"string.quoted.double.xml"===t||"string.quoted.single.xml"===t)))(s);if(o){return S(t,e,r,a,"string.quoted.double.xml"===o)}if((({editor:t,bufferPosition:e})=>{let r=!1;return t.backwardsScanInBufferRange(d,[e,[0,0]],(({matchText:t,stop:e})=>{t.startsWith("'")||t.startsWith('"')||("<"===t&&(r=!0),e())})),r})(t))return b(t,e,r,a,n)}return Promise.resolve([])};var $="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var B,j=(function(t,e){!function(t){t.parser=function(t,e){return new a(t,e)},t.SAXParser=a,t.SAXStream=o,t.createStream=function(t,e){return new o(t,e)},t.MAX_BUFFER_LENGTH=65536;var e,r=["comment","sgmlDecl","textNode","tagName","doctype","procInstName","procInstBody","entity","attribName","attribValue","cdata","script"];function a(e,n){if(!(this instanceof a))return new a(e,n);var o=this;!function(t){for(var e=0,a=r.length;e<a;e++)t[r[e]]=""}(o),o.q=o.c="",o.bufferCheckPosition=t.MAX_BUFFER_LENGTH,o.opt=n||{},o.opt.lowercase=o.opt.lowercase||o.opt.lowercasetags,o.looseCase=o.opt.lowercase?"toLowerCase":"toUpperCase",o.tags=[],o.closed=o.closedRoot=o.sawRoot=!1,o.tag=o.error=null,o.strict=!!e,o.noscript=!(!e&&!o.opt.noscript),o.state=A.BEGIN,o.strictEntities=o.opt.strictEntities,o.ENTITIES=o.strictEntities?Object.create(t.XML_ENTITIES):Object.create(t.ENTITIES),o.attribList=[],o.opt.xmlns&&(o.ns=Object.create(c)),o.trackPosition=!1!==o.opt.position,o.trackPosition&&(o.position=o.line=o.column=0),I(o,"onready")}t.EVENTS=["text","processinginstruction","sgmldeclaration","doctype","comment","opentagstart","attribute","opentag","closetag","opencdata","cdata","closecdata","error","end","ready","script","opennamespace","closenamespace"],Object.create||(Object.create=function(t){function e(){}return e.prototype=t,new e}),Object.keys||(Object.keys=function(t){var e=[];for(var r in t)t.hasOwnProperty(r)&&e.push(r);return e}),a.prototype={end:function(){S(this)},write:function(e){var a=this;if(this.error)throw this.error;if(a.closed)return C(a,"Cannot write after close. Assign an onready handler.");if(null===e)return S(a);"object"==typeof e&&(e=e.toString());for(var n=0,o="";o=U(e,n++),a.c=o,o;)switch(a.trackPosition&&(a.position++,"\n"===o?(a.line++,a.column=0):a.column++),a.state){case A.BEGIN:if(a.state=A.BEGIN_WHITESPACE,"\ufeff"===o)continue;j(a,o);continue;case A.BEGIN_WHITESPACE:j(a,o);continue;case A.TEXT:if(a.sawRoot&&!a.closedRoot){for(var s=n-1;o&&"<"!==o&&"&"!==o;)(o=U(e,n++))&&a.trackPosition&&(a.position++,"\n"===o?(a.line++,a.column=0):a.column++);a.textNode+=e.substring(s,n-1)}"<"!==o||a.sawRoot&&a.closedRoot&&!a.strict?(f(o)||a.sawRoot&&!a.closedRoot||D(a,"Text data outside of root node."),"&"===o?a.state=A.TEXT_ENTITY:a.textNode+=o):(a.state=A.OPEN_WAKA,a.startTagPosition=a.position);continue;case A.SCRIPT:"<"===o?a.state=A.SCRIPT_ENDING:a.script+=o;continue;case A.SCRIPT_ENDING:"/"===o?a.state=A.CLOSE_TAG:(a.script+="<"+o,a.state=A.SCRIPT);continue;case A.OPEN_WAKA:if("!"===o)a.state=A.SGML_DECL,a.sgmlDecl="";else if(f(o));else if(T(p,o))a.state=A.OPEN_TAG,a.tagName=o;else if("/"===o)a.state=A.CLOSE_TAG,a.tagName="";else if("?"===o)a.state=A.PROC_INST,a.procInstName=a.procInstBody="";else{if(D(a,"Unencoded <"),a.startTagPosition+1<a.position){var i=a.position-a.startTagPosition;o=new Array(i).join(" ")+o}a.textNode+="<"+o,a.state=A.TEXT}continue;case A.SGML_DECL:"[CDATA["===(a.sgmlDecl+o).toUpperCase()?(y(a,"onopencdata"),a.state=A.CDATA,a.sgmlDecl="",a.cdata=""):a.sgmlDecl+o==="--"?(a.state=A.COMMENT,a.comment="",a.sgmlDecl=""):"DOCTYPE"===(a.sgmlDecl+o).toUpperCase()?(a.state=A.DOCTYPE,(a.doctype||a.sawRoot)&&D(a,"Inappropriately located doctype declaration"),a.doctype="",a.sgmlDecl=""):">"===o?(y(a,"onsgmldeclaration",a.sgmlDecl),a.sgmlDecl="",a.state=A.TEXT):h(o)?(a.state=A.SGML_DECL_QUOTED,a.sgmlDecl+=o):a.sgmlDecl+=o;continue;case A.SGML_DECL_QUOTED:o===a.q&&(a.state=A.SGML_DECL,a.q=""),a.sgmlDecl+=o;continue;case A.DOCTYPE:">"===o?(a.state=A.TEXT,y(a,"ondoctype",a.doctype),a.doctype=!0):(a.doctype+=o,"["===o?a.state=A.DOCTYPE_DTD:h(o)&&(a.state=A.DOCTYPE_QUOTED,a.q=o));continue;case A.DOCTYPE_QUOTED:a.doctype+=o,o===a.q&&(a.q="",a.state=A.DOCTYPE);continue;case A.DOCTYPE_DTD:a.doctype+=o,"]"===o?a.state=A.DOCTYPE:h(o)&&(a.state=A.DOCTYPE_DTD_QUOTED,a.q=o);continue;case A.DOCTYPE_DTD_QUOTED:a.doctype+=o,o===a.q&&(a.state=A.DOCTYPE_DTD,a.q="");continue;case A.COMMENT:"-"===o?a.state=A.COMMENT_ENDING:a.comment+=o;continue;case A.COMMENT_ENDING:"-"===o?(a.state=A.COMMENT_ENDED,a.comment=P(a.opt,a.comment),a.comment&&y(a,"oncomment",a.comment),a.comment=""):(a.comment+="-"+o,a.state=A.COMMENT);continue;case A.COMMENT_ENDED:">"!==o?(D(a,"Malformed comment"),a.comment+="--"+o,a.state=A.COMMENT):a.state=A.TEXT;continue;case A.CDATA:"]"===o?a.state=A.CDATA_ENDING:a.cdata+=o;continue;case A.CDATA_ENDING:"]"===o?a.state=A.CDATA_ENDING_2:(a.cdata+="]"+o,a.state=A.CDATA);continue;case A.CDATA_ENDING_2:">"===o?(a.cdata&&y(a,"oncdata",a.cdata),y(a,"onclosecdata"),a.cdata="",a.state=A.TEXT):"]"===o?a.cdata+="]":(a.cdata+="]]"+o,a.state=A.CDATA);continue;case A.PROC_INST:"?"===o?a.state=A.PROC_INST_ENDING:f(o)?a.state=A.PROC_INST_BODY:a.procInstName+=o;continue;case A.PROC_INST_BODY:if(!a.procInstBody&&f(o))continue;"?"===o?a.state=A.PROC_INST_ENDING:a.procInstBody+=o;continue;case A.PROC_INST_ENDING:">"===o?(y(a,"onprocessinginstruction",{name:a.procInstName,body:a.procInstBody}),a.procInstName=a.procInstBody="",a.state=A.TEXT):(a.procInstBody+="?"+o,a.state=A.PROC_INST_BODY);continue;case A.OPEN_TAG:T(m,o)?a.tagName+=o:(O(a),">"===o?L(a):"/"===o?a.state=A.OPEN_TAG_SLASH:(f(o)||D(a,"Invalid character in tag name"),a.state=A.ATTRIB));continue;case A.OPEN_TAG_SLASH:">"===o?(L(a,!0),$(a)):(D(a,"Forward-slash in opening tag not followed by >"),a.state=A.ATTRIB);continue;case A.ATTRIB:if(f(o))continue;">"===o?L(a):"/"===o?a.state=A.OPEN_TAG_SLASH:T(p,o)?(a.attribName=o,a.attribValue="",a.state=A.ATTRIB_NAME):D(a,"Invalid attribute name");continue;case A.ATTRIB_NAME:"="===o?a.state=A.ATTRIB_VALUE:">"===o?(D(a,"Attribute without value"),a.attribValue=a.attribName,R(a),L(a)):f(o)?a.state=A.ATTRIB_NAME_SAW_WHITE:T(m,o)?a.attribName+=o:D(a,"Invalid attribute name");continue;case A.ATTRIB_NAME_SAW_WHITE:if("="===o)a.state=A.ATTRIB_VALUE;else{if(f(o))continue;D(a,"Attribute without value"),a.tag.attributes[a.attribName]="",a.attribValue="",y(a,"onattribute",{name:a.attribName,value:""}),a.attribName="",">"===o?L(a):T(p,o)?(a.attribName=o,a.state=A.ATTRIB_NAME):(D(a,"Invalid attribute name"),a.state=A.ATTRIB)}continue;case A.ATTRIB_VALUE:if(f(o))continue;h(o)?(a.q=o,a.state=A.ATTRIB_VALUE_QUOTED):(D(a,"Unquoted attribute value"),a.state=A.ATTRIB_VALUE_UNQUOTED,a.attribValue=o);continue;case A.ATTRIB_VALUE_QUOTED:if(o!==a.q){"&"===o?a.state=A.ATTRIB_VALUE_ENTITY_Q:a.attribValue+=o;continue}R(a),a.q="",a.state=A.ATTRIB_VALUE_CLOSED;continue;case A.ATTRIB_VALUE_CLOSED:f(o)?a.state=A.ATTRIB:">"===o?L(a):"/"===o?a.state=A.OPEN_TAG_SLASH:T(p,o)?(D(a,"No whitespace between attributes"),a.attribName=o,a.attribValue="",a.state=A.ATTRIB_NAME):D(a,"Invalid attribute name");continue;case A.ATTRIB_VALUE_UNQUOTED:if(!E(o)){"&"===o?a.state=A.ATTRIB_VALUE_ENTITY_U:a.attribValue+=o;continue}R(a),">"===o?L(a):a.state=A.ATTRIB;continue;case A.CLOSE_TAG:if(a.tagName)">"===o?$(a):T(m,o)?a.tagName+=o:a.script?(a.script+="</"+a.tagName,a.tagName="",a.state=A.SCRIPT):(f(o)||D(a,"Invalid tagname in closing tag"),a.state=A.CLOSE_TAG_SAW_WHITE);else{if(f(o))continue;v(p,o)?a.script?(a.script+="</"+o,a.state=A.SCRIPT):D(a,"Invalid tagname in closing tag."):a.tagName=o}continue;case A.CLOSE_TAG_SAW_WHITE:if(f(o))continue;">"===o?$(a):D(a,"Invalid characters in closing tag");continue;case A.TEXT_ENTITY:case A.ATTRIB_VALUE_ENTITY_Q:case A.ATTRIB_VALUE_ENTITY_U:var c,u;switch(a.state){case A.TEXT_ENTITY:c=A.TEXT,u="textNode";break;case A.ATTRIB_VALUE_ENTITY_Q:c=A.ATTRIB_VALUE_QUOTED,u="attribValue";break;case A.ATTRIB_VALUE_ENTITY_U:c=A.ATTRIB_VALUE_UNQUOTED,u="attribValue"}";"===o?(a[u]+=B(a),a.entity="",a.state=c):T(a.entity.length?g:d,o)?a.entity+=o:(D(a,"Invalid character in entity name"),a[u]+="&"+a.entity+o,a.entity="",a.state=c);continue;default:throw new Error(a,"Unknown state: "+a.state)}return a.position>=a.bufferCheckPosition&&function(e){for(var a=Math.max(t.MAX_BUFFER_LENGTH,10),n=0,o=0,s=r.length;o<s;o++){var i=e[r[o]].length;if(i>a)switch(r[o]){case"textNode":_(e);break;case"cdata":y(e,"oncdata",e.cdata),e.cdata="";break;case"script":y(e,"onscript",e.script),e.script="";break;default:C(e,"Max buffer length exceeded: "+r[o])}n=Math.max(n,i)}var c=t.MAX_BUFFER_LENGTH-n;e.bufferCheckPosition=c+e.position}(a),a}
/*! http://mths.be/fromcodepoint v0.1.0 by @mathias */,resume:function(){return this.error=null,this},close:function(){return this.write(null)},flush:function(){var t;_(t=this),""!==t.cdata&&(y(t,"oncdata",t.cdata),t.cdata=""),""!==t.script&&(y(t,"onscript",t.script),t.script="")}};try{e=u.default.Stream}catch(t){e=function(){}}var n=t.EVENTS.filter((function(t){return"error"!==t&&"end"!==t}));function o(t,r){if(!(this instanceof o))return new o(t,r);e.apply(this),this._parser=new a(t,r),this.writable=!0,this.readable=!0;var s=this;this._parser.onend=function(){s.emit("end")},this._parser.onerror=function(t){s.emit("error",t),s._parser.error=null},this._decoder=null,n.forEach((function(t){Object.defineProperty(s,"on"+t,{get:function(){return s._parser["on"+t]},set:function(e){if(!e)return s.removeAllListeners(t),s._parser["on"+t]=e,e;s.on(t,e)},enumerable:!0,configurable:!1})}))}o.prototype=Object.create(e.prototype,{constructor:{value:o}}),o.prototype.write=function(t){if("function"==typeof Buffer&&"function"==typeof Buffer.isBuffer&&Buffer.isBuffer(t)){if(!this._decoder){var e=l.default.StringDecoder;this._decoder=new e("utf8")}t=this._decoder.write(t)}return this._parser.write(t.toString()),this.emit("data",t),!0},o.prototype.end=function(t){return t&&t.length&&this.write(t),this._parser.end(),!0},o.prototype.on=function(t,r){var a=this;return a._parser["on"+t]||-1===n.indexOf(t)||(a._parser["on"+t]=function(){var e=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);e.splice(0,0,t),a.emit.apply(a,e)}),e.prototype.on.call(a,t,r)};var s="http://www.w3.org/XML/1998/namespace",i="http://www.w3.org/2000/xmlns/",c={xml:s,xmlns:i},p=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,m=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/,d=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,g=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/;function f(t){return" "===t||"\n"===t||"\r"===t||"\t"===t}function h(t){return'"'===t||"'"===t}function E(t){return">"===t||f(t)}function T(t,e){return t.test(e)}function v(t,e){return!T(t,e)}var N,b,w,A=0;for(var x in t.STATE={BEGIN:A++,BEGIN_WHITESPACE:A++,TEXT:A++,TEXT_ENTITY:A++,OPEN_WAKA:A++,SGML_DECL:A++,SGML_DECL_QUOTED:A++,DOCTYPE:A++,DOCTYPE_QUOTED:A++,DOCTYPE_DTD:A++,DOCTYPE_DTD_QUOTED:A++,COMMENT_STARTING:A++,COMMENT:A++,COMMENT_ENDING:A++,COMMENT_ENDED:A++,CDATA:A++,CDATA_ENDING:A++,CDATA_ENDING_2:A++,PROC_INST:A++,PROC_INST_BODY:A++,PROC_INST_ENDING:A++,OPEN_TAG:A++,OPEN_TAG_SLASH:A++,ATTRIB:A++,ATTRIB_NAME:A++,ATTRIB_NAME_SAW_WHITE:A++,ATTRIB_VALUE:A++,ATTRIB_VALUE_QUOTED:A++,ATTRIB_VALUE_CLOSED:A++,ATTRIB_VALUE_UNQUOTED:A++,ATTRIB_VALUE_ENTITY_Q:A++,ATTRIB_VALUE_ENTITY_U:A++,CLOSE_TAG:A++,CLOSE_TAG_SAW_WHITE:A++,SCRIPT:A++,SCRIPT_ENDING:A++},t.XML_ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'"},t.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},Object.keys(t.ENTITIES).forEach((function(e){var r=t.ENTITIES[e],a="number"==typeof r?String.fromCharCode(r):r;t.ENTITIES[e]=a})),t.STATE)t.STATE[t.STATE[x]]=x;function I(t,e,r){t[e]&&t[e](r)}function y(t,e,r){t.textNode&&_(t),I(t,e,r)}function _(t){t.textNode=P(t.opt,t.textNode),t.textNode&&I(t,"ontext",t.textNode),t.textNode=""}function P(t,e){return t.trim&&(e=e.trim()),t.normalize&&(e=e.replace(/\s+/g," ")),e}function C(t,e){return _(t),t.trackPosition&&(e+="\nLine: "+t.line+"\nColumn: "+t.column+"\nChar: "+t.c),e=new Error(e),t.error=e,I(t,"onerror",e),t}function S(t){return t.sawRoot&&!t.closedRoot&&D(t,"Unclosed root tag"),t.state!==A.BEGIN&&t.state!==A.BEGIN_WHITESPACE&&t.state!==A.TEXT&&C(t,"Unexpected end"),_(t),t.c="",t.closed=!0,I(t,"onend"),a.call(t,t.strict,t.opt),t}function D(t,e){if("object"!=typeof t||!(t instanceof a))throw new Error("bad call to strictFail");t.strict&&C(t,e)}function O(t){t.strict||(t.tagName=t.tagName[t.looseCase]());var e=t.tags[t.tags.length-1]||t,r=t.tag={name:t.tagName,attributes:{}};t.opt.xmlns&&(r.ns=e.ns),t.attribList.length=0,y(t,"onopentagstart",r)}function F(t,e){var r=t.indexOf(":")<0?["",t]:t.split(":"),a=r[0],n=r[1];return e&&"xmlns"===t&&(a="xmlns",n=""),{prefix:a,local:n}}function R(t){if(t.strict||(t.attribName=t.attribName[t.looseCase]()),-1!==t.attribList.indexOf(t.attribName)||t.tag.attributes.hasOwnProperty(t.attribName))t.attribName=t.attribValue="";else{if(t.opt.xmlns){var e=F(t.attribName,!0),r=e.prefix,a=e.local;if("xmlns"===r)if("xml"===a&&t.attribValue!==s)D(t,"xml: prefix must be bound to "+s+"\nActual: "+t.attribValue);else if("xmlns"===a&&t.attribValue!==i)D(t,"xmlns: prefix must be bound to "+i+"\nActual: "+t.attribValue);else{var n=t.tag,o=t.tags[t.tags.length-1]||t;n.ns===o.ns&&(n.ns=Object.create(o.ns)),n.ns[a]=t.attribValue}t.attribList.push([t.attribName,t.attribValue])}else t.tag.attributes[t.attribName]=t.attribValue,y(t,"onattribute",{name:t.attribName,value:t.attribValue});t.attribName=t.attribValue=""}}function L(t,e){if(t.opt.xmlns){var r=t.tag,a=F(t.tagName);r.prefix=a.prefix,r.local=a.local,r.uri=r.ns[a.prefix]||"",r.prefix&&!r.uri&&(D(t,"Unbound namespace prefix: "+JSON.stringify(t.tagName)),r.uri=a.prefix);var n=t.tags[t.tags.length-1]||t;r.ns&&n.ns!==r.ns&&Object.keys(r.ns).forEach((function(e){y(t,"onopennamespace",{prefix:e,uri:r.ns[e]})}));for(var o=0,s=t.attribList.length;o<s;o++){var i=t.attribList[o],c=i[0],u=i[1],l=F(c,!0),p=l.prefix,m=l.local,d=""===p?"":r.ns[p]||"",g={name:c,value:u,prefix:p,local:m,uri:d};p&&"xmlns"!==p&&!d&&(D(t,"Unbound namespace prefix: "+JSON.stringify(p)),g.uri=p),t.tag.attributes[c]=g,y(t,"onattribute",g)}t.attribList.length=0}t.tag.isSelfClosing=!!e,t.sawRoot=!0,t.tags.push(t.tag),y(t,"onopentag",t.tag),e||(t.noscript||"script"!==t.tagName.toLowerCase()?t.state=A.TEXT:t.state=A.SCRIPT,t.tag=null,t.tagName=""),t.attribName=t.attribValue="",t.attribList.length=0}function $(t){if(!t.tagName)return D(t,"Weird empty close tag."),t.textNode+="</>",void(t.state=A.TEXT);if(t.script){if("script"!==t.tagName)return t.script+="</"+t.tagName+">",t.tagName="",void(t.state=A.SCRIPT);y(t,"onscript",t.script),t.script=""}var e=t.tags.length,r=t.tagName;t.strict||(r=r[t.looseCase]());for(var a=r;e--&&t.tags[e].name!==a;)D(t,"Unexpected close tag");if(e<0)return D(t,"Unmatched closing tag: "+t.tagName),t.textNode+="</"+t.tagName+">",void(t.state=A.TEXT);t.tagName=r;for(var n=t.tags.length;n-- >e;){var o=t.tag=t.tags.pop();t.tagName=t.tag.name,y(t,"onclosetag",t.tagName);var s={};for(var i in o.ns)s[i]=o.ns[i];var c=t.tags[t.tags.length-1]||t;t.opt.xmlns&&o.ns!==c.ns&&Object.keys(o.ns).forEach((function(e){var r=o.ns[e];y(t,"onclosenamespace",{prefix:e,uri:r})}))}0===e&&(t.closedRoot=!0),t.tagName=t.attribValue=t.attribName="",t.attribList.length=0,t.state=A.TEXT}function B(t){var e,r=t.entity,a=r.toLowerCase(),n="";return t.ENTITIES[r]?t.ENTITIES[r]:t.ENTITIES[a]?t.ENTITIES[a]:("#"===(r=a).charAt(0)&&("x"===r.charAt(1)?(r=r.slice(2),n=(e=parseInt(r,16)).toString(16)):(r=r.slice(1),n=(e=parseInt(r,10)).toString(10))),r=r.replace(/^0+/,""),isNaN(e)||n.toLowerCase()!==r?(D(t,"Invalid character entity"),"&"+t.entity+";"):String.fromCodePoint(e))}function j(t,e){"<"===e?(t.state=A.OPEN_WAKA,t.startTagPosition=t.position):f(e)||(D(t,"Non-whitespace before first tag."),t.textNode=e,t.state=A.TEXT)}function U(t,e){var r="";return e<t.length&&(r=t.charAt(e)),r}A=t.STATE,String.fromCodePoint||(N=String.fromCharCode,b=Math.floor,w=function(){var t,e,r=16384,a=[],n=-1,o=arguments.length;if(!o)return"";for(var s="";++n<o;){var i=Number(arguments[n]);if(!isFinite(i)||i<0||i>1114111||b(i)!==i)throw RangeError("Invalid code point: "+i);i<=65535?a.push(i):(t=55296+((i-=65536)>>10),e=i%1024+56320,a.push(t,e)),(n+1===o||a.length>r)&&(s+=N.apply(null,a),a.length=0)}return s},Object.defineProperty?Object.defineProperty(String,"fromCodePoint",{value:w,configurable:!0,writable:!0}):String.fromCodePoint=w)}(e)}(B={exports:{}},B.exports),B.exports);function U(t,e){var r;!function(t){let e;if(e="function"==typeof atom.workspace.isTextEditor?atom.workspace.isTextEditor(t):"function"==typeof t.getText,!e)throw new Error("Invalid TextEditor provided")}(t);let a=e;("number"!=typeof a||!Number.isFinite(a)||a<0)&&(a=0);const n=t.getBuffer(),o=n.getLineCount()-1;if(a>o)throw new Error(`Line number (${a}) greater than maximum line (${o})`);const s=null!==(r=n.lineForRow(a))&&void 0!==r?r:"";let i=s.length,c=0;{const t=s.match(/^\s+/);t&&(c=t[0].length)}if(c>s.length)throw new Error(`Column start (${c||0}) greater than line length (${s.length}) for line ${a}`);return[[a,c],[a,i]]}const M=/^(?:[a-z][a-z0-9+\-.]*:)?\/\//i,k=/\s*[^\s]+\s*PUBLIC\s*("([^"]+)"|'([^']+)')/,V=(t,e,r)=>{var a,n,o,s,i;const u=t.getPath(),l=u?c.default.dirname(u):__dirname,p=[],m=[],d=[],g=j.parser(!0);let f,h,E,T=0,v=!1,N=!1,b={};const w=t=>t&&d.push(M.test(t)?t:c.default.resolve(l,t));g.onerror=()=>v=!0,g.ondoctype=t=>{N=!0;const e=t.match(k);e&&(E=e[2]||e[3])},g.onprocessinginstruction=e=>{if("xml-model"!==e.name)return;const{href:r,type:a,schematypens:n}=(t=>{const e={};return t.replace(/(\w+)="(.+?)"/g,((t,r,a)=>e[r]=a)),e})(e.body);let o=null;r&&("application/relax-ng-compact-syntax"===a?o="rnc":"http://relaxng.org/ns/structure/1.0"===n?o=".rnc"===c.default.extname(r)?"rnc":"rng":"http://purl.oclc.org/dsdl/schematron"===n?o="sch.iso":"http://www.ascc.net/xml/schematron"===n?o="sch.15":"http://www.w3.org/2001/XMLSchema"===n?w(r):p.push({severity:"warning",excerpt:"Unknown schema type",location:{file:u,position:U(t,T)}})),o&&m.push({lang:o,lineOfReference:T,path:M.test(r)?r:c.default.resolve(l,r)})},g.onopentag=t=>{if(v)return;const[e,r]=(t=>{const e=t.indexOf(":");return[t.substr(0,e),t.substr(e+1)]})(t.name);f=e?t.attributes["xmlns:"+e]:t.attributes.xmlns,h=r,b=t.attributes,(t=>{const e=[];return Object.keys(t).forEach((r=>{const a=r.match(/xmlns:(.*)/);a&&"http://www.w3.org/2001/XMLSchema-instance"===t[r]&&e.push(a[1])})),e})(t.attributes).forEach((e=>{const r=t.attributes[e+":noNamespaceSchemaLocation"];r&&w(r.trim());const a=t.attributes[e+":schemaLocation"];a&&a.trim().split(/[ \t\r\n]+/).filter(((t,e)=>!!(e%2))).forEach(w)})),v=!0};const A=t.getBuffer(),x=A.getLineCount();for(;!v&&T<x;){const t=A.lineForRow(T)||"",e=t.length;let r=0;for(;!v&&r<e;)g.write(t.substr(r,64)),r+=64;T++}d.length&&m.push({lang:"xsd",path:d.join("*")});const I={rootScopes:t.getRootScopeDescriptor().getScopesArray(),filePath:u,rootNs:f,rootLocalName:h,rootAttributes:b,publicId:E},y=e.getMatchingOutcome(I),_=null!==(a=null==y?void 0:y.xmlCatalog)&&void 0!==a?a:r.xmlCatalog,P=null!==(n=null==y?void 0:y.dtdValidation)&&void 0!==n?n:r.dtdValidation,C=null!==(o=null==y?void 0:y.xIncludeAware)&&void 0!==o?o:r.xIncludeAware,S=null!==(s=null==y?void 0:y.xIncludeFixupBaseUris)&&void 0!==s?s:r.xIncludeFixupBaseUris,D=null!==(i=null==y?void 0:y.xIncludeFixupLanguage)&&void 0!==i?i:r.xIncludeFixupLanguage;return!m.length&&(null==y?void 0:y.schemaProps)&&m.push(...y.schemaProps),N&&("always"===P||"fallback"===P&&!m.length)&&m.push({lang:"dtd",path:null,lineOfReference:g.line}),m.length||m.push({lang:"none",path:null}),{xmlModelWarnings:p,parserConfig:{filePath:u,schemaProps:m,xmlCatalog:_,xIncludeAware:C,xIncludeFixupBaseUris:S,xIncludeFixupLanguage:D}}},G=(t,e)=>{e?console.error(`[linter-autocomplete-jing] ${t}`,e):console.error(`[linter-autocomplete-jing] ${t}`)},q=Array.isArray,Y=t=>"[object Object]"===Object.prototype.toString.call(t),W=t=>"string"==typeof t,X=t=>{if(!Y(t))throw new Error("Rule must be an object.");if(!("test"in t)||!("outcome"in t))throw new Error('Rules must to have "test" and "outcome" properties.');if("priority"in t&&("number"!=typeof(e=t.priority)||!isFinite(e)))throw new Error('"priority" must be a number.');var e;if(!Y(t.test))throw new Error('"test" must be an object.');if(!Y(t.outcome))throw new Error('"outcome" must be an object.');if("grammarScope"in t.test&&!W(t.test.grammarScope))throw new Error('"test.grammarScope" must be a string.');if("pathRegex"in t.test&&!W(t.test.pathRegex))throw new Error('"test.pathRegex" must be a string.');if("rootNs"in t.test&&!W(t.test.rootNs))throw new Error('"test.rootNs" must be a string.');if("rootLocalName"in t.test&&!W(t.test.rootLocalName))throw new Error('"test.rootLocalName" must be a string.');if("rootAttributes"in t.test&&!Y(t.test.rootAttributes))throw new Error('"test.rootAttributes" must be an object.');if("xmlCatalog"in t.outcome&&!W(t.outcome.xmlCatalog))throw new Error('"outcome.xmlCatalog" must be a string.');if("dtdValidation"in t.outcome&&"never"!==t.outcome.dtdValidation&&"always"!==t.outcome.dtdValidation&&"fallback"!==t.outcome.dtdValidation)throw new Error('"outcome.dtdValidation" must be "never", "always" or "fallback".');if("schemaProps"in t.outcome){if(!q(t.outcome.schemaProps))throw new Error('"outcome.schemaProps" must be an array.');t.outcome.schemaProps.forEach(((t,e)=>{if(!Y(t))throw new Error(`"outcome.schemaProps[${e}]" must be an object.`);if(!("lang"in t)||!("path"in t))throw new Error(`"outcome.schemaProps[${e}]" must have "lang" and "path" properties.`);if(!W(t.lang))throw new Error(`"outcome.schemaProps[${e}].lang" must be a string.`);if(!W(t.path))throw new Error(`"outcome.schemaProps[${e}].path" must be a string.`)}))}return!0},H=t=>(t.forEach(((t,e)=>{try{X(t)}catch(t){throw new Error(`Error in rule at index ${e}: ${t.message}`)}})),!0),z=(t,e)=>{const r={...t};return r.xmlCatalog&&(r.xmlCatalog=c.default.resolve(e,r.xmlCatalog)),r.schemaProps&&(r.schemaProps=r.schemaProps.map((({path:t,lang:r})=>({path:c.default.resolve(e,t),lang:r})))),r},Q=t=>(t=>t.reduce(((t,e)=>{const{settings:r}=e;return Array.isArray(r)?t.concat(r):t}),[]))(t).reduce(((t,e)=>{var r,a;const{path:n,properties:o}=e,s=null===(a=null===(r=null==o?void 0:o[".text.xml"])||void 0===r?void 0:r.validation)||void 0===a?void 0:a.rules;if(!n||!Array.isArray(s))return t;try{H(s)}catch(e){return G(`Skipping rules from ${n}: ${e.message}`),t}const i=c.default.dirname(n),u=s.map((({priority:t,test:e,outcome:r})=>({priority:t,test:e,outcome:z(r,i)})));return t.concat(u)}),[]),J=(t,e)=>({rootAttributes:r})=>r[t]===e,Z=({grammarScope:t,pathRegex:e,rootNs:r,rootLocalName:a,rootAttributes:n,publicId:o})=>{const s=[];var i;if(t&&s.push((i=t,({rootScopes:t})=>t.includes(i))),e&&s.push((t=>{try{const e=new RegExp(t);return({filePath:t})=>!!t&&e.test(t)}catch(e){return G(`Could not parse RegExp "${t}"`,e),()=>!1}})(e)),r&&s.push((t=>({rootNs:e})=>t===e)(r)),a&&s.push((t=>({rootLocalName:e})=>t===e)(a)),n)for(const t of Object.keys(n))s.push(J(t,n[t]));return o&&s.push((t=>({publicId:e})=>t===e)(o)),0===s.length?()=>!1:t=>s.every((e=>e(t)))},K=t=>t.sort(((t,e)=>{var r,a;return(null!==(r=e.priority)&&void 0!==r?r:0)-(null!==(a=t.priority)&&void 0!==a?a:0)})),tt=t=>({matches:Z(t.test),outcome:t.outcome});const et=t=>{atom.notifications.addError(`[linter-autocomplete-jing] ${t.message}`,{detail:t.stack,dismissable:!0})},rt=(t,e,r,a)=>t.map((t=>{if(!t)return null;const n=e.getPath();return t.systemId!==n?r.displaySchemaWarnings||"warning"!==t.level?((t,e,r,a)=>{const n="warning"===t.level?"Schema parser warning: ":"Could not process schema or catalog: ",o=a.find((e=>e.path===t.systemId&&e.lang===t.lang));return{severity:"warning",excerpt:n+t.text,location:{file:e,position:o?U(r,o.lineOfReference):[[0,0],[0,0]]}}})(t,n,e,a.schemaProps):null:((t,e,r)=>({severity:"warning"===t.level?t.level:"error",excerpt:"none"===t.lang?t.text:`${t.text} [${t.lang.toUpperCase()}]`,location:{file:e,position:U(r,t.line-1)}}))(t,n,e)})).filter((t=>!!t)),at=(t,e,r)=>new Promise(((a,o)=>{let s="";const i=new n.Socket;i.on("connect",(()=>{i.write(e.map((t=>`-${t}\n`)).join("")),null!==r&&(i.write("\n"),i.write(r)),i.end()})),i.on("data",(t=>{s+=t.toString()})),i.on("close",(()=>{a(s)})),i.on("error",(t=>{i.destroy(),o(t)})),i.connect({port:t})}));var nt=st;function ot(t,e,r){return!(!t.isSymbolicLink()&&!t.isFile())&&function(t,e){var r=void 0!==e.pathExt?e.pathExt:process.env.PATHEXT;if(!r)return!0;if(-1!==(r=r.split(";")).indexOf(""))return!0;for(var a=0;a<r.length;a++){var n=r[a].toLowerCase();if(n&&t.substr(-n.length).toLowerCase()===n)return!0}return!1}(e,r)}function st(t,e,r){m.default.stat(t,(function(a,n){r(a,!a&&ot(n,t,e))}))}st.sync=function(t,e){return ot(m.default.statSync(t),t,e)};var it,ct=ut;function ut(t,e,r){m.default.stat(t,(function(t,a){r(t,!t&&lt(a,e))}))}function lt(t,e){return t.isFile()&&function(t,e){var r=t.mode,a=t.uid,n=t.gid,o=void 0!==e.uid?e.uid:process.getuid&&process.getuid(),s=void 0!==e.gid?e.gid:process.getgid&&process.getgid(),i=parseInt("100",8),c=parseInt("010",8),u=parseInt("001",8),l=i|c;return r&u||r&c&&n===s||r&i&&a===o||r&l&&0===o}(t,e)}ut.sync=function(t,e){return lt(m.default.statSync(t),e)},it="win32"===process.platform||$.TESTING_WINDOWS?nt:ct;var pt=mt;function mt(t,e,r){if("function"==typeof e&&(r=e,e={}),!r){if("function"!=typeof Promise)throw new TypeError("callback not provided");return new Promise((function(r,a){mt(t,e||{},(function(t,e){t?a(t):r(e)}))}))}it(t,e||{},(function(t,a){t&&("EACCES"===t.code||e&&e.ignoreErrors)&&(t=null,a=!1),r(t,a)}))}mt.sync=function(t,e){try{return it.sync(t,e||{})}catch(t){if(e&&e.ignoreErrors||"EACCES"===t.code)return!1;throw t}};const dt="win32"===process.platform||"cygwin"===process.env.OSTYPE||"msys"===process.env.OSTYPE,gt=dt?";":":",ft=t=>Object.assign(new Error(`not found: ${t}`),{code:"ENOENT"}),ht=(t,e)=>{const r=e.colon||gt,a=t.match(/\//)||dt&&t.match(/\\/)?[""]:[...dt?[process.cwd()]:[],...(e.path||process.env.PATH||"").split(r)],n=dt?e.pathExt||process.env.PATHEXT||".EXE;.CMD;.BAT;.COM":"",o=dt?n.split(r):[""];return dt&&-1!==t.indexOf(".")&&""!==o[0]&&o.unshift(""),{pathEnv:a,pathExt:o,pathExtExe:n}},Et=(t,e,r)=>{"function"==typeof e&&(r=e,e={}),e||(e={});const{pathEnv:a,pathExt:n,pathExtExe:o}=ht(t,e),s=[],i=r=>new Promise(((n,o)=>{if(r===a.length)return e.all&&s.length?n(s):o(ft(t));const i=a[r],l=/^".*"$/.test(i)?i.slice(1,-1):i,p=c.default.join(l,t),m=!l&&/^\.[\\\/]/.test(t)?t.slice(0,2)+p:p;n(u(m,r,0))})),u=(t,r,a)=>new Promise(((c,l)=>{if(a===n.length)return c(i(r+1));const p=n[a];pt(t+p,{pathExt:o},((n,o)=>{if(!n&&o){if(!e.all)return c(t+p);s.push(t+p)}return c(u(t,r,a+1))}))}));return r?i(0).then((t=>r(null,t)),r):i(0)};var Tt=Et;Et.sync=(t,e)=>{e=e||{};const{pathEnv:r,pathExt:a,pathExtExe:n}=ht(t,e),o=[];for(let s=0;s<r.length;s++){const i=r[s],u=/^".*"$/.test(i)?i.slice(1,-1):i,l=c.default.join(u,t),p=!u&&/^\.[\\\/]/.test(t)?t.slice(0,2)+l:l;for(let t=0;t<a.length;t++){const r=p+a[t];try{if(pt.sync(r,{pathExt:n})){if(!e.all)return r;o.push(r)}}catch(t){}}}if(e.all&&o.length)return o;if(e.nothrow)return null;throw ft(t)};const vt=(t={})=>{const e=t.env||process.env;return"win32"!==(t.platform||process.platform)?"PATH":Object.keys(e).reverse().find((t=>"PATH"===t.toUpperCase()))||"Path"};var Nt=vt,bt=vt;function wt(t,e){const r=t.options.env||process.env,a=process.cwd(),n=null!=t.options.cwd,o=n&&void 0!==process.chdir&&!process.chdir.disabled;if(o)try{process.chdir(t.options.cwd)}catch(t){}let s;try{s=Tt.sync(t.command,{path:r[Nt({env:r})],pathExt:e?c.default.delimiter:void 0})}catch(t){}finally{o&&process.chdir(a)}return s&&(s=c.default.resolve(n?t.options.cwd:"",s)),s}Nt.default=bt;var At=function(t){return wt(t)||wt(t,!0)};const xt=/([()\][%!^"`<>&|;, *?])/g;var It={command:function(t){return t=t.replace(xt,"^$1")},argument:function(t,e){return t=(t=`"${t=(t=(t=`${t}`).replace(/(\\*)"/g,'$1$1\\"')).replace(/(\\*)$/,"$1$1")}"`).replace(xt,"^$1"),e&&(t=t.replace(xt,"^$1")),t}},yt=/^#!(.*)/;var _t=function(t){const e=Buffer.alloc(150);let r;try{r=m.default.openSync(t,"r"),m.default.readSync(r,e,0,150,0),m.default.closeSync(r)}catch(t){}return((t="")=>{const e=t.match(yt);if(!e)return null;const[r,a]=e[0].replace(/#! ?/,"").split(" "),n=r.split("/").pop();return"env"===n?a:a?`${n} ${a}`:n})(e.toString())};const Pt="win32"===process.platform,Ct=/\.(?:com|exe)$/i,St=/node_modules[\\/].bin[\\/][^\\/]+\.cmd$/i;function Dt(t){if(!Pt)return t;const e=function(t){t.file=At(t);const e=t.file&&_t(t.file);return e?(t.args.unshift(t.file),t.command=e,At(t)):t.file}(t),r=!Ct.test(e);if(t.options.forceShell||r){const r=St.test(e);t.command=c.default.normalize(t.command),t.command=It.command(t.command),t.args=t.args.map((t=>It.argument(t,r)));const a=[t.command].concat(t.args).join(" ");t.args=["/d","/s","/c",`"${a}"`],t.command=process.env.comspec||"cmd.exe",t.options.windowsVerbatimArguments=!0}return t}var Ot=function(t,e,r){e&&!Array.isArray(e)&&(r=e,e=null);const a={command:t,args:e=e?e.slice(0):[],options:r=Object.assign({},r),file:void 0,original:{command:t,args:e}};return r.shell?a:Dt(a)};const Ft="win32"===process.platform;function Rt(t,e){return Object.assign(new Error(`${e} ${t.command} ENOENT`),{code:"ENOENT",errno:"ENOENT",syscall:`${e} ${t.command}`,path:t.command,spawnargs:t.args})}function Lt(t,e){return Ft&&1===t&&!e.file?Rt(e.original,"spawn"):null}var $t={hookChildProcess:function(t,e){if(!Ft)return;const r=t.emit;t.emit=function(a,n){if("exit"===a){const a=Lt(n,e);if(a)return r.call(t,"error",a)}return r.apply(t,arguments)}},verifyENOENT:Lt,verifyENOENTSync:function(t,e){return Ft&&1===t&&!e.file?Rt(e.original,"spawnSync"):null},notFoundError:Rt};function Bt(t,e,r){const a=Ot(t,e,r),n=p.default.spawn(a.command,a.args,a.options);return $t.hookChildProcess(n,a),n}var jt=Bt,Ut=Bt,Mt=function(t,e,r){const a=Ot(t,e,r),n=p.default.spawnSync(a.command,a.args,a.options);return n.error=n.error||$t.verifyENOENTSync(n.status,a),n},kt=Ot,Vt=$t;jt.spawn=Ut,jt.sync=Mt,jt._parse=kt,jt._enoent=Vt;class Gt extends Error{constructor(t,e){super(t),this.name="ServerProcessError",e&&(this.stack=e.stack)}}var qt;!function(t){t[t.STOPPED=0]="STOPPED",t[t.INITIALIZING=1]="INITIALIZING",t[t.READY=2]="READY"}(qt||(qt={}));class Yt{constructor(){this.state=qt.STOPPED,this.portPromise=null,this.javaProcess=null}isStopped(){return this.state===qt.INITIALIZING}async getPortIfReadyNow(){return this.state!==qt.READY?null:this.portPromise}async getPortIfStartupTriggered(){return this.portPromise}ensurePort(t){return this.portPromise||(this.portPromise=this.startup(t)),this.portPromise}shutdown(){this.state=qt.STOPPED,this.javaProcess&&(this.removeListeners(this.javaProcess),this.javaProcess.kill(),this.javaProcess=null),this.portPromise=null}async startup(t){this.state=qt.INITIALIZING;try{const e=[...t.jvmArguments.split(/\s+/),"-jar",c.default.resolve(__dirname,"../vendor/xml-tools-server-0.4.8.jar"),"0",String(t.schemaCacheSize)];this.javaProcess=jt(t.javaExecutablePath,e,{});const r=await this.waitForPort(t.javaExecutablePath,this.javaProcess);return this.removeListeners(this.javaProcess),this.setDefaultListeners(this.javaProcess),this.state=qt.READY,r}catch(t){throw this.shutdown(),t}}waitForPort(t,e){return new Promise(((r,a)=>{if(!e.stdout||!e.stderr)return a(new Gt("Configuration error: the Java child process must provide standard streams"));e.stdout.on("data",(t=>{const e=t.toString().match(/XML Tools Server listening on port (\d+)/);if(e){const t=Number(e[1]);r(t)}else a(new Gt(`Unexpected message on server startup: "${t}"`))})),e.stderr.on("data",(t=>{a(new Gt(`Unexpected error on server startup: "${t}"`))})),e.on("error",(e=>{a(new Gt(`Failed to run Java server. Please make sure Java is installed and can be run with the Java executable path in the "linter-autocomplete-jing" package settings ("${t}").`,e))}))}))}setDefaultListeners(t){var e;null===(e=t.stderr)||void 0===e||e.on("data",(t=>{G(`Server message on standard error stream: "${t}"`)})),t.on("error",(t=>{et(t),this.shutdown()}))}removeListeners(t){var e,r;null===(e=t.stdout)||void 0===e||e.removeAllListeners("data"),null===(r=t.stderr)||void 0===r||r.removeAllListeners("data"),t.removeAllListeners("error")}}const Wt={none:"",localparts:"w",all:"wn"},Xt=/^([a-z0-9.]+?):((.*?):\s?)?((\d+):)?(?:\d+:\s)?(error|fatal|warning):\s(.*)$/;let Ht=new t.CompositeDisposable;const zt=new class{constructor(t){this.config={jvmArguments:"-Xms32m -Xmx256m",javaExecutablePath:"java",schemaCacheSize:10},this.serverProcessManager=t||new Yt}async requestValidation(t,e){const r=await this.serverProcessManager.ensurePort(this.config),a=(t=>{const{filePath:e,schemaProps:r,xmlCatalog:a,xIncludeAware:n,xIncludeFixupBaseUris:o,xIncludeFixupLanguage:s}=t;return["V",["r",n?"x":"",o?"f":"",s?"l":""].join(""),"UTF-8",null!=e?e:"",null!=a?a:"",...r.map((t=>t.lang+" "+(t.path||"")))]})(t);return(await at(r,a,e)).trim().split(/\r?\n/).map((t=>t?(t=>{const e=Xt.exec(t);if(!e)return G(`Could not parse message "${t}"`),null;const[,r,,a,,n,o,s]=e;return{lang:r,systemId:a,line:Number(n),level:o,text:s}})(t):null))}async requestAutocompleteSuggestions(t,e,r,a){const n=await this.serverProcessManager.ensurePort(this.config),o=((t,e,r)=>{const{schemaProps:a,filePath:n,xmlCatalog:o,xIncludeAware:s,xIncludeFixupBaseUris:i,xIncludeFixupLanguage:c}=t,u=((t,e)=>e.find((({lang:e})=>("rng"===e||"rnc"===e||"xsd"===e)&&t.autocompleteScope[e]))||{lang:"none",path:null})(e,a),{type:l,attName:p,tagEndDelimiterBufferIndex:m}=r;return["A",l,p||"",m||"",["r",Wt[e.wildcardSuggestions],s?"x":"",i?"f":"",c?"l":""].join(""),"UTF-8",null!=n?n:"undefined",o||"",u.lang+" "+(u.path||"")]})(t,e,r);try{const t=await at(n,o,a);return JSON.parse(t)}catch(t){return G("Error requesting suggestions",t),[]}}setJavaExecutablePath(t){this.config.javaExecutablePath!==t&&(this.config.javaExecutablePath=t,this.serverProcessManager.isStopped()||this.serverProcessManager.shutdown())}setJvmArguments(t){this.config.jvmArguments!==t&&(this.config.jvmArguments=t,this.serverProcessManager.isStopped()||this.serverProcessManager.shutdown())}async setSchemaCacheSize(t){if(this.config.schemaCacheSize!==t){this.config.schemaCacheSize=t;try{const e=await this.serverProcessManager.getPortIfStartupTriggered();if(null===e)return;await at(e,["S",t],null)}catch(t){et(t)}}}async clearSchemaCache(){try{const t=await this.serverProcessManager.getPortIfReadyNow();if(null===t)return;await at(t,["C"],null)}catch(t){et(t)}}shutdown(){this.serverProcessManager.shutdown()}},Qt=new class{constructor(){this.configRules=[],this.packageRules=[],this.allRules=[]}setConfigRules(t){this.configRules=K(t).map(tt),this.allRules=this.configRules.concat(this.packageRules)}setPackageRules(t){this.packageRules=K(t).map(tt),this.allRules=this.configRules.concat(this.packageRules)}getAll(){return this.allRules}getMatchingOutcome(t){const e=this.allRules.find((e=>e.matches(t)));return null==e?void 0:e.outcome}},Jt=[],Zt={xmlCatalog:"",dtdValidation:"fallback",xIncludeAware:!0,xIncludeFixupBaseUris:!0,xIncludeFixupLanguage:!0},Kt={displaySchemaWarnings:!1},te={wildcardSuggestions:"none",autocompletePriority:1,autocompleteScope:{rnc:!0,rng:!0,xsd:!0}},ee=()=>{const t=atom.grammars.getGrammars().map((t=>t.scopeName)).filter((t=>null==t?void 0:t.startsWith("text.xml")));Jt.splice(0,Jt.length,...t);const e=atom.packages.getActivePackages(),r=Q(e);Qt.setPackageRules(r)};let re=!1;exports.activate=function(){require("atom-package-deps").install("linter-autocomplete-jing"),Ht=new t.CompositeDisposable,Ht.add(atom.config.observe("linter-autocomplete-jing.rules",(t=>{if(Array.isArray(t)){try{H(t)}catch(a){return e=`Could not set rules from user config: ${a.message}`,r=JSON.stringify(t,null,2),void atom.notifications.addWarning(`[linter-autocomplete-jing] ${e}`,{detail:r,dismissable:!0})}Qt.setConfigRules(t)}var e,r}))),Ht.add(atom.config.observe("linter-autocomplete-jing.jvmArguments",(t=>zt.setJvmArguments(t)))),Ht.add(atom.config.observe("linter-autocomplete-jing.javaExecutablePath",(t=>zt.setJavaExecutablePath(t)))),Ht.add(atom.config.observe("linter-autocomplete-jing.schemaCacheSize",(t=>zt.setSchemaCacheSize(t)))),Object.keys(Zt).forEach((t=>Ht.add(atom.config.observe(`linter-autocomplete-jing.${t}`,(e=>{Zt[t]=e}))))),Ht.add(atom.config.observe("linter-autocomplete-jing.displaySchemaWarnings",(t=>{Kt.displaySchemaWarnings=t}))),Object.keys(te).forEach((t=>Ht.add(atom.config.observe(`linter-autocomplete-jing.${t}`,(e=>{te[t]=e}))))),Ht.add(atom.commands.add("atom-workspace",{"linter-autocomplete-jing:clear-schema-cache":()=>zt.clearSchemaCache()}));const e=()=>{Ht.add(atom.packages.onDidActivatePackage(ee)),Ht.add(atom.packages.onDidDeactivatePackage(ee))};atom.packages.hasActivatedInitialPackages()?(ee(),e()):Ht.add(atom.packages.onDidActivateInitialPackages((()=>{ee(),e()})))},exports.deactivate=function(){Ht.dispose(),zt.shutdown()},exports.provideAutocomplete=function(){return{selector:".text.xml",disableForSelector:".comment, .string.unquoted.cdata.xml",inclusionPriority:te.autocompletePriority,excludeLowerPriority:!0,async getSuggestions(t){if(re)return atom.commands.dispatch(atom.views.getView(t.editor),"autocomplete-plus:cancel"),re=!1,null;try{const{parserConfig:e}=V(t.editor,Qt,Zt);return L(t,te,e,zt)}catch(t){return et(t),[]}},onDidInsertSuggestion({editor:t,suggestion:e}){e.retrigger?setTimeout((()=>(t=>{atom.commands.dispatch(atom.views.getView(t),"autocomplete-plus:activate",{activatedManually:!1})})(t)),1):(re=!0,setTimeout((()=>{re=!1}),300))}}},exports.provideLinter=function(){return{name:"Jing",grammarScopes:Jt,scope:"file",lintsOnChange:!0,async lint(t){if(!t.getPath())return null;try{const{parserConfig:e,xmlModelWarnings:r}=V(t,Qt,Zt);return(await(async(t,e,r,a)=>{const n=await a.requestValidation(r,t.getText());return rt(n,t,e,r)})(t,Kt,e,zt)).concat(r).sort(((t,e)=>t.location.position[0][0]-e.location.position[0][0]))}catch(t){return et(t),[]}}}},exports.xmlService=zt;
//# sourceMappingURL=main.js.map
